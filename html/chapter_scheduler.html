<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>Max API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
	<div id="c74header">
		<img src="header.png" height="100" />
	</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('chapter_scheduler.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">The Scheduler </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Max scheduler permits operations to be delayed until a later time.</p>
<p>It keeps track of time in double-precision, but the resolution of the scheduler depends on the user's environment preferences. The scheduler also works in conjunction with a low-priority queue, which permits time-consuming operations that might be initiated inside the scheduler to be executed in a way that does not disrupt timing accuracy.</p>
<p>Most objects interface with the scheduler via a clock (<a class="el" href="group__clocks.html#ga09c0580122113b4db2517ff8e7c8b0f2" title="A clock. ">t_clock</a>) object. A clock is associated with a task function that will execute when the scheduler's current time reaches the clock's time. There is also a function called <a class="el" href="group__threading.html#gabb52201ce22f2636ee0d844a6aae39c9" title="Cause a function to be executed at the timer level at some time in the future. ">schedule()</a> that can be used for one-off delayed execution of a function. It creates a clock to do its job however, so if your object is going to be using the scheduler repeatedly, it is more efficient to store references to the clocks it creates so the clocks can be reused.</p>
<p>The scheduler is periodically polled to see if it needs to execute clock tasks. There are numerous preferences Max users can set to determine when and how often this polling occurs. Briefly:</p>
<ul>
<li>The Overdrive setting determines whether scheduler polling occurs in a high-prority timer thread or the main thread</li>
<li>The Interval setting determines the number of milliseconds elapse between polling the scheduler</li>
<li>The Throttle setting determines how many tasks can be executed in any particular scheduler poll</li>
</ul>
<p>Similar Throttle and Interval settings exist for the low-priority queue as well.</p>
<p>For more information refer to the <a class="el" href="group__sched.html">Timing</a> documentation. While the details might be a little overwhelming on first glance, the important point is that the exact time your scheduled task will execute is subject to variability. Max permits this level of user control over the scheduler to balance all computational needs for a specific application.</p>
<h1><a class="anchor" id="chapter_scheduler_clocks"></a>
Creating and Using Clocks</h1>
<p>There are five steps to using a clock in an external object.</p>
<p>1. Add a member to your object's data structure to hold a pointer to the clock object </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>_myobject</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="structt__object.html">t_object</a> m_obj;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> *m_clock;</div>
<div class="line">} <a class="code" href="structt__object.html">t_object</a>;</div>
</div><!-- fragment --><p>2. Write a task function that will do something when the clock is executed. The function has only a single argument, a pointer to your object. The example below gets the current scheduler time and prints it.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> myobject_task(t_myobject *x)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">double</span> time;</div>
<div class="line"></div>
<div class="line">    sched_getftime(&amp;time);</div>
<div class="line">    <a class="code" href="group__console.html#ga8eebb1400d598f4423f925102d02970a">post</a>(<span class="stringliteral">&quot;instance %lx is executing at time %.2f&quot;</span>, x, time);</div>
<div class="line">}</div>
</div><!-- fragment --><p>3. In your new instance routine, create the clock (passing a pointer to your object and the task function) and store the result in your object's data structure. </p><div class="fragment"><div class="line">x-&gt;m_clock = <a class="code" href="group__clocks.html#ga6257ddd41904756699208f135f6539fd">clock_new</a>((<a class="code" href="structt__object.html">t_object</a> *)x, (<a class="code" href="group__datatypes.html#ga4b2c39d5bd0b08acd10bffed77f0e513">method</a>)myobject_task);</div>
</div><!-- fragment --><p>4. Schedule your clock. Use <a class="el" href="group__clocks.html#ga61719f0e0379fffbe79ae2bd5699b66f" title="Schedule the execution of a Clock using a floating-point argument. ">clock_fdelay()</a> to schedule the clock in terms of a delay from the current time. Below we schedule the clock to execute 100 milliseconds from now. </p><div class="fragment"><div class="line"><a class="code" href="group__clocks.html#ga61719f0e0379fffbe79ae2bd5699b66f">clock_fdelay</a>(x-&gt;m_clock, 100.);</div>
</div><!-- fragment --><p>If you want to cancel the execution of a clock for some reason, you can use <a class="el" href="group__clocks.html#ga64f5f8a027b39c1c14464744a9cc08ce" title="Cancel the scheduled execution of a Clock. ">clock_unset()</a>. </p><div class="fragment"><div class="line"><a class="code" href="group__clocks.html#ga64f5f8a027b39c1c14464744a9cc08ce">clock_unset</a>(x-&gt;m_clock);</div>
</div><!-- fragment --><p>5. In your object's free routine, free the clock </p><div class="fragment"><div class="line"><a class="code" href="group__obj.html#ga3759846cb356195532c41e35b87522ee">object_free</a>(x-&gt;m_clock);</div>
</div><!-- fragment --><p>Note that if you call <a class="el" href="group__clocks.html#ga9ac56d198904627333de740743086920" title="Schedule the execution of a Clock. ">clock_delay()</a> on a clock that is already set, its execution time will be changed. It won't execute twice.</p>
<h1><a class="anchor" id="chapter_scheduler_qelems"></a>
Creating and Using Qelems</h1>
<p>A qelem ("queue element") is used to ensure that an operation occurs in the low-priority thread. The task function associated with a <a class="el" href="group__qelems.html#ga4d219449d88d2b9648a992152b278090" title="A qelem. ">t_qelem</a> is executed when the low-priority queue is serviced, always in the main (user interface) thread. Any qelem that is "set" belongs to the low-priority queue and will be executed as soon as it serviced.</p>
<p>There are two principal things you want to avoid in the high priority thread: first, time-consuming or unpredictable operations such as file access, and second, anything that will block execution for any length of time &ndash; for example, showing a dialog box (including a file dialog).</p>
<p>The procedure for using a qelem is analogous to that for using a clock.</p>
<p>1. Add a member to your object's data structure to hold a pointer to the qelem </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>_myobject</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="structt__object.html">t_object</a> m_obj;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> *m_qelem</div>
<div class="line">} t_myobject;</div>
</div><!-- fragment --><p>2. Write a task function that will do something when the qelem is executed. The function has only a single argument, a pointer to your object. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> myobject_qtask(t_myobject *x)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__console.html#ga8eebb1400d598f4423f925102d02970a">post</a>(<span class="stringliteral">&quot;I am being executed a low priority!&quot;</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>3. In your new instance routine, create the qelem (passing a pointer to your object and the task function) and store the result in your object's data structure. </p><div class="fragment"><div class="line">x-&gt;m_qelem = <a class="code" href="group__qelems.html#gaffa7e9d4d5468a8ae3c825a353609b1b">qelem_new</a>((<a class="code" href="structt__object.html">t_object</a> *)x, (<a class="code" href="group__datatypes.html#ga4b2c39d5bd0b08acd10bffed77f0e513">method</a>)myobject_qtask);</div>
</div><!-- fragment --><p>4. Set the qelem by using <a class="el" href="group__qelems.html#ga3e292aad133af89a87e167e88cc4a1b5" title="Cause a Qelem to execute. ">qelem_set()</a>. You could, for example, call <a class="el" href="group__qelems.html#ga3e292aad133af89a87e167e88cc4a1b5" title="Cause a Qelem to execute. ">qelem_set()</a> in a clock task function or in direct response to a message such as bang or int. </p><div class="fragment"><div class="line"><a class="code" href="group__qelems.html#ga3e292aad133af89a87e167e88cc4a1b5">qelem_set</a>(x-&gt;m_qelem);</div>
</div><!-- fragment --><p>If you want to cancel the execution of a qelem for some reason, you can use <a class="el" href="group__qelems.html#ga021eca2eff6e47ff97ca112fb2eaf866" title="Cancel a Qelem&#39;s execution. ">qelem_unset()</a>. </p><div class="fragment"><div class="line"><a class="code" href="group__qelems.html#ga021eca2eff6e47ff97ca112fb2eaf866">qelem_unset</a>(x-&gt;m_qelem);</div>
</div><!-- fragment --><p>5. In your object's free routine, call <a class="el" href="group__qelems.html#ga7cfcb3134eb0baf335847906a14a08d0" title="Free a Qelem object created with qelem_new(). ">qelem_free()</a>. Do not call <a class="el" href="group__obj.html#ga3759846cb356195532c41e35b87522ee" title="Call the free function and release the memory for an instance of an internal object class previously ...">object_free()</a> or <a class="el" href="group__class__old.html#gadf30646e52376a37b93cc20efac65636" title="Release the memory used by a Max object. ">freeobject()</a> &ndash; unlike the clock, the qelem is not an object. </p><div class="fragment"><div class="line"><a class="code" href="group__qelems.html#ga7cfcb3134eb0baf335847906a14a08d0">qelem_free</a>(x-&gt;m_qelem);</div>
</div><!-- fragment --><p>Note that if you call <a class="el" href="group__qelems.html#ga3e292aad133af89a87e167e88cc4a1b5" title="Cause a Qelem to execute. ">qelem_set()</a> on a qelem that is already set, it won't execute twice. This is a feature, not a bug, as it permits you to execute a low-priority task only as fast as the low-priority queue operates, not at the high-priority rate that the task might be triggered. An example would be that a number box will redraw more slowly than a counter that changes its value. This is not something you need to worry about, even if you are writing UI objects, as Max handles it internally (using a qelem).</p>
<h1><a class="anchor" id="chapter_scheduler_defer"></a>
Defer</h1>
<p>The defer function and its variants use a qelem to ensure that a function executes at low-priority. There are three variants: <a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a>, <a class="el" href="group__threading.html#ga486daa40ddb16f70b663615695d18315" title="Defer execution of a function to the back of the queue on the main thread. ">defer_low()</a>, and defer_medium(). The difference between using <a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a> and a qelem is that <a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a> is a one-shot deal &ndash; it creates a qelem, sets it, and then gets rid of it when the task function has executed. The effect of this is that if you have some rapid high-priority event that needs to trigger something to happen at low-priority, <a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a> will ensure that this low-priority task happens every time the high-priority event occurs (in a 1:1 ratio), whereas using a qelem will only run the task at a rate that corresponds to the service interval of the low-priority queue. If you repeatedly <a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a> something too rapidly, the low-priority queue will become backlogged and the responsiveness of the UI will suffer.</p>
<p>A typical use of <a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a> is if your object implements a read message to ask the user for a file. Opening the dialog in the timer thread and waiting for user input will likely crash, but even if it didn't, the scheduler would effectively stop.</p>
<p>To use <a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a>, you write a deferred task function that will execute at low priority. The function will be passed a pointer to your object, plus a symbol and atom list modeled on the prototype for an anything method. You need not pass any arguments to the deferred task if you don't need them, however.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> myobject_deferredtask(t_myobject *x, <a class="code" href="structt__symbol.html">t_symbol</a> *s, <span class="keywordtype">long</span> argc, <a class="code" href="structt__atom.html">t_atom</a> *argv)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__console.html#ga8eebb1400d598f4423f925102d02970a">post</a>(<span class="stringliteral">&quot;I am deferred&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>To call the task, use <a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a> as shown below. The first example passes no arguments. The second passes a couple of long atoms. </p><div class="fragment"><div class="line"><a class="code" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643">defer</a>((<a class="code" href="structt__object.html">t_object</a> *)x, (<a class="code" href="group__datatypes.html#ga4b2c39d5bd0b08acd10bffed77f0e513">method</a>)myobject_deferredtask, NULL, 0, NULL);</div>
<div class="line"></div>
<div class="line"><a class="code" href="structt__atom.html">t_atom</a> av[2];</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__atom.html#ga68c9b634425c7e246734ef4ecd911d1c">atom_setlong</a>(av, 1);</div>
<div class="line"><a class="code" href="group__atom.html#ga68c9b634425c7e246734ef4ecd911d1c">atom_setlong</a>(av+ 2, 74);</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643">defer</a>((<a class="code" href="structt__object.html">t_object</a> *)x, (<a class="code" href="group__datatypes.html#ga4b2c39d5bd0b08acd10bffed77f0e513">method</a>)myobject_deferredtask, NULL, 2, av);</div>
</div><!-- fragment --><p>Defer copies any atoms you pass to newly allocated memory, which it frees when the deferred task has executed.</p>
<h2><a class="anchor" id="chapter_scheduler_defer_variants"></a>
Defer Variants</h2>
<p>defer has two variants, <a class="el" href="group__threading.html#ga486daa40ddb16f70b663615695d18315" title="Defer execution of a function to the back of the queue on the main thread. ">defer_low()</a> and defer_medium(). Here is a comparison:</p>
<p><a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a></p>
<p>If executing at high priority, <a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a> puts the deferred task at the front of the low-priority queue. If not executing at highpriority, <a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a> calls the deferred task immediately.</p>
<p><a class="el" href="group__threading.html#ga486daa40ddb16f70b663615695d18315" title="Defer execution of a function to the back of the queue on the main thread. ">defer_low()</a></p>
<p>At all priority levels, <a class="el" href="group__threading.html#ga486daa40ddb16f70b663615695d18315" title="Defer execution of a function to the back of the queue on the main thread. ">defer_low()</a> puts the deferred task at the back of the low-priority queue.</p>
<p>defer_medium()</p>
<p>If executing at high priority, defer_medium() puts the deferred task at the back of the low-priority queue. If not executing at high priority, defer_medium() calls the deferred task immediately.</p>
<h1><a class="anchor" id="chapter_scheduler_sechedule"></a>
Schedule</h1>
<p>The <a class="el" href="group__threading.html#gabb52201ce22f2636ee0d844a6aae39c9" title="Cause a function to be executed at the timer level at some time in the future. ">schedule()</a> function is to clocks as <a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a> is to qelems. Schedule creates a clock for a task function you specify and calls <a class="el" href="group__clocks.html#ga61719f0e0379fffbe79ae2bd5699b66f" title="Schedule the execution of a Clock using a floating-point argument. ">clock_fdelay()</a> on it to make the task execute at a desired time. As with <a class="el" href="group__threading.html#gaa24a0c9896f1ad241e45590065c3f643" title="Defer execution of a function to the main thread if (and only if) your function is executing in the s...">defer()</a>, <a class="el" href="group__threading.html#gabb52201ce22f2636ee0d844a6aae39c9" title="Cause a function to be executed at the timer level at some time in the future. ">schedule()</a> can copy arguments to be delivered to the task when it executes.</p>
<p>A <a class="el" href="group__threading.html#gabb52201ce22f2636ee0d844a6aae39c9" title="Cause a function to be executed at the timer level at some time in the future. ">schedule()</a> variant, schedule_defer(), executes the task function at low priority after a specified delay. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
		<div id="c74footer">
			&nbsp;&nbsp;Copyright &copy; 2015, <a href="http://www.cycling74.com/">Cycling '74</a>
		</div>
	</body>
</html>
