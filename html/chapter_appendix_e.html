<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>Max API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
	<div id="c74header">
		<img src="header.png" height="100" />
	</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('chapter_appendix_e.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Appendix: Updating Externals for Max 6.1 (x64 architecture) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="chapter_appendix_e_background"></a>
Background</h1>
<p>The Max 6.0.x application binary, and the external objects and libraries it uses, are compiled for the i386 processor architecture. This architecture uses 32-bit memory addressing, meaning that the size of a pointer is 32 bits (or 4 bytes).</p>
<p>Max 6.1 introduces support for the x86_64 (or x64) architecture which uses 64-bit (8 bytes) memory addressing. Among the benefits are the ability to use more than 2 GB of memory in Max. Additionally, the size of the <a class="el" href="structt__atom.html" title="An atom is a typed datum. ">t_atom</a> is 8-bytes on x64, meaning that double-precision floating pointer numbers can be represented.</p>
<p>For backwards compatibility, Max 6.1 also continues to be distributed as a 32-bit application binary. On the Windows platform the 32-bit and 64-bit applications are distributed separately, as are the external objects you create for them. On the Mac platform a Universal Binary (or "FAT" binary) is distributed containing both the 32-bit and 64-bit versions in the same dynamically-loaded library.</p>
<p>All externals on the Mac remain bundles using the ".mxo" filename extension.</p>
<p>32-bit externals on Windows remain DLLs using the ".mxe" filename extension.</p>
<p>64-bit externals on Windows are still DLLs but use a new ".mxe64" filename extension.</p>
<h2><a class="anchor" id="chapter_appendix_e_types"></a>
New Types</h2>
<p>In addition to the change of size in a pointer, there are some additional changes for 64-bit. For example, a "long" integer for 32-bit targets is 4 bytes on both the Mac and Windows. However, a "long" integer for 64-bit targets is 4 bytes on Windows but 8 bytes (the size of a pointer) on the Mac!</p>
<p>To facilitate cross platform code that is independent of these platform differences, the Max 6.1 API defines some new types used throughout the SDK.</p>
<p>Types of fixed size:</p>
<div class="fragment"><div class="line"><a class="code" href="group__misc.html#gae9d986356a53175c960d51230a5f4046">t_int8</a></div>
<div class="line"><a class="code" href="group__misc.html#ga0914b90e8ac459280d7a279030e57bd5">t_uint8</a></div>
<div class="line"><a class="code" href="group__misc.html#gaa8dfcde2eee8bf33600dc9f80e678f81">t_int16</a></div>
<div class="line"><a class="code" href="group__misc.html#ga2f8b43fd51d852dadf2f4e8fb70b6a50">t_uint16</a></div>
<div class="line"><a class="code" href="group__misc.html#ga7d4c427b5ac97669ee113c3534bc89d6">t_int32</a></div>
<div class="line"><a class="code" href="group__misc.html#gabfbbea99683e39f738a9394e1f192f46">t_uint32</a></div>
<div class="line"><a class="code" href="group__misc.html#ga47584eb849d62c0e261a88313f3c5e87">t_int64</a></div>
<div class="line"><a class="code" href="group__misc.html#ga804d26101c9d442d10edfab156f13c9a">t_uint64</a></div>
</div><!-- fragment --><p>Types of architecture-dependent size:</p>
<div class="fragment"><div class="line"><a class="code" href="group__misc.html#gaa922947bfdd14fc2553971accc813528">t_ptr_int</a> : an <span class="keywordtype">int</span> that is the same size as a pointer</div>
<div class="line"><a class="code" href="group__misc.html#gaf04d137d27cc99529adf6bdc7f04a610">t_ptr_uint</a> : an <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> that is the same size as a pointer</div>
<div class="line"><a class="code" href="group__misc.html#gadc4636574e13a47cc6dc4f9b6622ab9f">t_atom_long</a> : the type that is an <a class="code" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a002f28879581a6f66ea492b994b96f1e">A_LONG</a> in an atom (32-bits on i386; 64-bits on x64)</div>
<div class="line"><a class="code" href="group__misc.html#gae909b008a2edede04a9332b9fbe2e4e2">t_atom_float</a> : the type that is an <a class="code" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a0b3aa0ab8104573dfc9cb70b5b08031f">A_FLOAT</a> in an atom (<span class="keywordtype">float</span> on i386; <span class="keywordtype">double</span> on x64)</div>
</div><!-- fragment --><p>Types for specific contexts:</p>
<div class="fragment"><div class="line"><a class="code" href="group__misc.html#ga5b7fe3ffb8a3e56752bf33f7dedf2f72">t_filepath</a> : i.e. path/vol in file APIs identifying a folder</div>
<div class="line"><a class="code" href="group__misc.html#ga1fea4eebce8d3a1d7c0da7d4e1d7921d">t_fourcc</a> : use <span class="keywordflow">for</span> type codes in <a class="code" href="group__files.html#gace9f6c70d9d937bd157f5c382618c5fd">locatefile_extended</a>(), file dialogs, etc. to represent a four <span class="keywordtype">char</span> code</div>
<div class="line"><a class="code" href="group__misc.html#ga399f0cab8235c1b1cf9208900f25e4a5">t_getbytes_size</a> : <span class="keywordflow">if</span> you are <span class="keyword">using</span> <a class="code" href="group__memory.html#gad4269b29be988878da2d8d5579696d60">getbytes</a>() and <a class="code" href="group__memory.html#ga5520eadf3494221726cfaf3cbd35f8e9">freebytes</a>(), use this type to represent the size of the memory</div>
</div><!-- fragment --><h1><a class="anchor" id="chapter_appendix_e_projects"></a>
Xcode and Visual Studio Projects</h1>
<p>For new objects, you can base projects on those in the new SDK. To update existing projects you will need to make a few changes to your project settings.</p>
<h2><a class="anchor" id="chapter_appendix_e_projects_mac"></a>
Mac / Xcode</h2>
<p>Max 6.1 on the Mac no longer uses the intermediary MaxAPI.framework for linking. Instead, the linking is handled at runtime and the symbols are checked using special flags to the linker. To update an existing project:</p>
<ol type="1">
<li>remove references to the MaxAPI.framework</li>
<li>update the .xcconfig file on which the project is based with the .xcconfig file in the new Max SDK</li>
<li>in your target's build settings find the "Other Linker Flags" and set it to "$(C74_SYM_LINKER_FLAGS)"</li>
<li>in your target's build settings find the "Architectures" and set it to "i386 x86_64"</li>
</ol>
<h2><a class="anchor" id="chapter_appendix_e_projects_win"></a>
Windows / Visual Studio</h2>
<p>In order to build for x64 with Visual Studio 2008, you must have the "Pro" version. The free "Express" version will not work. The "Express" versions of Visual Studio 2010 and 2012 do work (2012 is recommended).</p>
<p>Due to bugs in Visual Studio 2008, it is really difficult to update an existing project. Instead, it is recommended to simply create a new Visual Studio project based on an existing example. For Visual Studio 2008 use the "vcproj" files. For Visual Studio 2010 and 2012 use the "vcxproj" files.</p>
<ol type="1">
<li>choose a relevant starting point, e.g., the "dummy" example project</li>
<li>copy it to the folder your old project was in, rename it</li>
<li>open it in a text editor such as "sublime text 2"</li>
<li>do a find/replace for all instances of the text "dummy" changing it to your object's name</li>
<li>open the Visual Studio project and build you can choose either "Win32" or "x64" from the platform drop-down menu in the IDE</li>
</ol>
<h1><a class="anchor" id="chapter_appendix_e_code"></a>
Changes to Code</h1>
<h2><a class="anchor" id="chapter_appendix_e_code_atoms"></a>
Atoms</h2>
<p>Any assumptions in your code about the size of a <a class="el" href="structt__atom.html" title="An atom is a typed datum. ">t_atom</a> or the size of its members should be reviewed. When setting or getting values to and from atoms you should use the types <a class="el" href="group__misc.html#gadc4636574e13a47cc6dc4f9b6622ab9f" title="the type that is an A_LONG in a t_atom ">t_atom_long</a> and <a class="el" href="group__misc.html#gae909b008a2edede04a9332b9fbe2e4e2" title="the type that is an A_FLOAT in a t_atom ">t_atom_float</a> as appropriate.</p>
<h2><a class="anchor" id="chapter_appendix_e_code_returnvals"></a>
Return Values</h2>
<p>All methods which return a value must return a pointer-sized value, e.g., <a class="el" href="group__misc.html#gaa922947bfdd14fc2553971accc813528" title="a pointer-sized int ">t_ptr_int</a>, <a class="el" href="group__misc.html#gaf04d137d27cc99529adf6bdc7f04a610" title="an unsigned pointer-sized int ">t_ptr_uint</a>, <a class="el" href="group__misc.html#gaace8607dfb500e6dcca022a35fcb8386" title="an integer value suitable to be returned as an error code ">t_max_err</a>, etc.</p>
<h2><a class="anchor" id="chapter_appendix_e_code_files"></a>
File Code</h2>
<p>File access in Max involves several areas subject to either required or suggested update.</p>
<p>A path in Max has traditionally been represented with a short int; it is recommened to now use the new <a class="el" href="group__misc.html#ga5b7fe3ffb8a3e56752bf33f7dedf2f72" title="i.e. path/vol in file APIs identifying a folder ">t_filepath</a> type.</p>
<p>File types in Max are represented using four char codes. Traditionally these have been defined using variables of type "long", which is now problematic. This is a 4-byte type but the long on the Mac for x64 is 8-bytes. These must be updated to use the new <a class="el" href="group__misc.html#ga1fea4eebce8d3a1d7c0da7d4e1d7921d" title="an integer of suitable size to hold a four char code / identifier ">t_fourcc</a> type.</p>
<h2><a class="anchor" id="chapter_appendix_e_gotchas"></a>
Miscellaneous Gotchas</h2>
<p>Look for any ld or lu strings in sprintf() or related formatting functions.</p>
<h1><a class="anchor" id="chapter_appendix_e_scenarios"></a>
Common Scenarios</h1>
<h2><a class="anchor" id="chapter_appendix_e_scenarios_long"></a>
"Long" integers</h2>
<p>One of biggest areas we've had to address is the use of the long datatype. The reason for this is that under 64bit windows a long integer is 32 bits and under 64bit OS X (and Unix), a long is a 64 bit integer.</p>
<p>To assist in this process, we have a the new data types documented above. We'll distinguis these from what we are calling a "platform long".</p>
<p>This platform long discrepancy can lead to all sorts of problems which are outlined with a brief statement of the problem scenario, and our recommended fix with types:</p>
<p><b>Problem: long integers as A_LONG/A_DEFLONG method arguments (this includes your object constructors)</b></p>
<p>Solution: type your A_LONG/A_DEFLONG methods' function signatures to use the t_atom_long in place of long</p>
<p><b>Problem: long integers as A_CANT method arguments called only through <a class="el" href="group__obj.html#gae740749094827ac5adc2b7145db1c596" title="Sends an untyped message to an object. ">object_method()</a></b></p>
<p>Solution: either redefine your A_CANT method's arguments to t_atom_long, or define your type as A_DIRECT, and make use of the <a class="el" href="group__obj.html#ga059445066cc5e1bb358db166e79b8d47" title="do a strongly typed direct call to a method of an object ">object_method_direct()</a> macro, passing in a function prototype to the macro (also see under floating point how this is required for anything which previously was A_CANT with floating point values). Technically many of these will still work properly due to the nature of how integers are passed on the stack under x64, without any change, it is still best practice.</p>
<p><b>Problem: long integers being used to store pointers as integer values either for pointer arithmetic, attributes, or other situations.</b></p>
<p>Solution: use t_atom_long or even better t_ptr_uint (for pointer sized unsigned integer) or the actual pointer type.</p>
<p><b>Problem: long integers as four character codes for filetypes (t_fourcc) which applies to locatefile_extended and path functions and friends</b></p>
<p>Solution: Use t_foucc inplace of long, for anywhere you are using filetype codes.</p>
<p><b>Problem: long integers as return values for functions called via <a class="el" href="group__obj.html#gae740749094827ac5adc2b7145db1c596" title="Sends an untyped message to an object. ">object_method()</a></b></p>
<p>Solution: These should always return a t_atom_long or other pointer sized integer</p>
<p><b>Problem: long integers passed as pointers into functions like <a class="el" href="group__dictionary.html#gaad76485d9efc4f8948f11eb5f4c863ce" title="Retrieve a long integer from the dictionary. ">dictionary_getlong()</a> which are now prototyped to take a t_atom_long *</b></p>
<p>Solution: Use a t_atom_long value, and pass a pointer to it. A cast from a platform long *to a t_atom_long * is not safe.</p>
<p><b>Problem: long integers for performing bitwise manipulation of 32bit floating point values including byteswapping</b></p>
<p>Solution: Use t_int32/t_uint32</p>
<p>There are many cases where it is safe to use long integers, and we have continued to use them in our code. Below are the scenarios where they are okay and in several cases required. This might provide some confusion at some points, but hopefully it makes the porting process a little bit easier, allowing more code to remain unchanged.</p>
<ul>
<li>Attributes defined as _sym_long should remain a platform long. If you need to have a t_atom_long attribute, you will need to use the new atom_long attribute type. This is probably the most confusing aspect of porting to 64bit and a very real ambiguity of the word "long". Unfortunately, having to balance the difficulties of porting with the clarity of API, this is something we felt necessary to do.</li>
<li>Attribute getters/setters should still use the long type for ac. this is especially important for getters which are passed a pointer to a platform long in the ac value.</li>
<li>A_GIMME methods may still use the long type for ac without issues</li>
</ul>
<h2><a class="anchor" id="chapter_appendix_e_scenarios_float"></a>
Floating point values</h2>
<p>For A_FLOAT/A_DEFFLOAT function signatures, you should always use double as is currently recommended in the Max SDK. You should not use the new t_atom_float dataype. (this includes your object constructors)</p>
<p>For A_CANT functions with floating point arguments that currently use <a class="el" href="group__obj.html#gae740749094827ac5adc2b7145db1c596" title="Sends an untyped message to an object. ">object_method()</a>. You will need to use <a class="el" href="group__obj.html#ga059445066cc5e1bb358db166e79b8d47" title="do a strongly typed direct call to a method of an object ">object_method_direct()</a> or pass in pointers to the floating point values (which is safe as it is a pointer sized integer). It is no longer possible to pass floats through <a class="el" href="group__obj.html#gae740749094827ac5adc2b7145db1c596" title="Sends an untyped message to an object. ">object_method()</a> or the many functions like it (<a class="el" href="group__linklist.html#ga10bd8d367039e3e4b90fe720e83d0edf" title="Call the named message on every object in the linklist. ">linklist_methodall()</a>, <a class="el" href="group__hashtab.html#ga816a6164c9565fd4269e2b9d8e8a76a3" title="Call the named message on every object in the hashtab. ">hashtab_methodall()</a>, etc.)</p>
<p>Attributes are already defined in terms of their bitsize float32 or float 64. If you wish for your attribute to make use of the new atom support for double preceision. You will want to change your struct definition, as well as your attribute constructor to be a double (_sym_float64). There isn't currently a t_atom_float attribute type like we've added for long.</p>
<h2><a class="anchor" id="chapter_appendix_e_scenarios_apple"></a>
Deprecated Apple types</h2>
<p>like Byte/Boolean/Point/etc</p>
<p>Use the t_byte/t_bool/t_point/etc types instead.</p>
<h1><a class="anchor" id="chapter_appendix_e_misc"></a>
Additional Miscellaneous Changes</h1>
<p>The old 32-bit 'dsp' (and perform) methods are no longer supported as of Max 6.1. They must be updated as per <a class="el" href="chapter_appendix_d.html#chapter_appendix_d_msp64">Updating MSP Externals for 64-bit Audio Processing</a> .</p>
<h1><a class="anchor" id="chapter_appendix_e_resources"></a>
Additional Resources</h1>
<ul>
<li><a href="http://www.viva64.com/en/a/0004/">http://www.viva64.com/en/a/0004/</a></li>
<li><a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/Cocoa64BitGuide/64BitChangesCocoa/64BitChangesCocoa.html">https://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/Cocoa64BitGuide/64BitChangesCocoa/64BitChangesCocoa.html</a></li>
<li><a href="https://developer.apple.com/library/mac/#documentation/Carbon/Conceptual/Carbon64BitGuide/OtherAPIChanges/OtherAPIChanges.html">https://developer.apple.com/library/mac/#documentation/Carbon/Conceptual/Carbon64BitGuide/OtherAPIChanges/OtherAPIChanges.html</a></li>
<li><a href="http://msdn.microsoft.com/en-us/magazine/cc300794.aspx">http://msdn.microsoft.com/en-us/magazine/cc300794.aspx</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
		<div id="c74footer">
			&nbsp;&nbsp;Copyright &copy; 2015, <a href="http://www.cycling74.com/">Cycling '74</a>
		</div>
	</body>
</html>
